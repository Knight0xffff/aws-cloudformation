AWSTemplateFormatVersion: '2010-09-09'
Description: 'Deploy StarRocks on Amazon Web Services in a new VPC.'
Metadata:
  LICENSE: Apache License Version 2.0
  QuickStartDocumentation:
    EntrypointName: "Parameters for deploying StatRocsk into an new VPC"
    Order: "1"
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Network configuration
      Parameters:
      - AvailabilityZones
    - Label:
        default: EC2 configuration
      Parameters:
      - KeyPairName
    - Label:
        default: AMI's id
      Parameters:
      - StaRocksAmiId
    - Label:
        default: Bastion AMI's id
      Parameters:
      - BastionAmiId

    # StarRocks Cluster configuration
    - Label:
        default: StarRocks Cluster configuration
      Parameters:
      - FeNodeCount
      - FeNodeInstanceType
      - BeNodeCount
      - BeNodeInstanceType

    # Fe configuration
    - Label:
        default: Fe configuration
      Parameters:
      - LogDir
      - SysLogLevel
      - MetaDir
      - HttpPort
      - RpcPort
      - QueryPort
      - EditLogPort
    
    # BE configuration
    - Label:
        default: BE configuration
      Parameters:
      - SysLogDir
      - SysLogLevel
      - BePort
      - WebserverPort
      - HeartbeatServicePort
      - BrpcPort
      - VolumeType
      - VolumeSize
    ParameterLabels:
      AvailabilityZones:
        default: Availability Zones
      KeyPairName:
        default: Key pair name
      StaRocksAmiId:
        default: StaRocks Ami Id
      BastionAmiId:
        default: Bastion Ami Id
      FeNodeCount:
        default: Number of StarRocks Fe
      FeNodeInstanceType:
        default: Fe instance type
      BeNodeCount:
        default: Number of StarRocks Be
      BeNodeInstanceType:
        default: Be instance type

      # FE
      LogDir:
        default: Dir to save fe log
      SysLogLevel:
        default: Sys Log Level
      MetaDir:
        default: Meta data dir
      HttpPort:
        default: Fe http port
      RpcPort:
        default: Fe rpc port
      QueryPort:
        default: Fe query port
      EditLogPort:
        default: Fe edit log port

      # BE
      SysLogDir:
        default: Dir to save be sys log
      SysLogLevel:
        default: Sys Log Level
      BePort:
        default: Be port
      WebserverPort:
        default: Webserver port
      HeartbeatServicePort:
        default: Heartbeat service port
      BrpcPort:
        default: Brpc port
      VolumeType:
        default: Volume type of Be nodes
      VolumeSize:
        default: Volume size of Be nodes
Parameters:
  AvailabilityZones:
    Description: List of Availability Zones (AZs) to use for the VPC subnets. More AZs improve the availability of the system, and fewer AZs reduce the cost of data traffic between AZs).Please select two or more
    Type: List<AWS::EC2::AvailabilityZone::Name>
  KeyPairName: 
    Type: AWS::EC2::KeyPair::KeyName
    Description: Public/private key pairs allow you to securely connect to your instance after it launches.
    Default: CFT-Test
  StaRocksAmiId:
    Description: StaRocksAmiId
    Type: String
    Default: ami-0bd79263a676ee313
  BastionAmiId:
    Description: BastionAmiId
    Type: String
    Default: ami-019ef4a13f29ddecb
  FeNodeCount:
    Type: Number
    Default: 1
    Description: Number of StarRocks Fe
    AllowedValues: 
      - 1
      - 2
      - 3
  FeNodeInstanceType:
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
    Default: t2.micro
    Description: Amazon EC2 instance type for fe instances.
    Type: String
  BeNodeCount:
    Type: Number
    Default: 3
    Description: Number of StarRocks Be
    AllowedValues: 
      - 3
      - 4
      - 5
      - 6
  BeNodeInstanceType:
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
    Default: t2.micro
    Description: Amazon EC2 instance type for be instances.
    Type: String

  # Fe
  LogDir:
    Description: Dir to save log, please to fill in the absolute path
    Type: String
    Default: fe default log path
  SysLogLevel:
    Description: Sys Log Level, please select from the drop-down menu
    Type: String
    Default: INFO
    AllowedValues: 
      - INFO
      - WARN
      - ERROR
      - FATAL
  MetaDir:
    Description: Dir to save mete data, please to fill in the absolute path
    Type: String
    Default: fe default meta path
  HttpPort:
    Description: Fe http port
    Type: String
    Default: 8030
  RpcPort:
    Description: Fe rpc port
    Type: String
    Default: 9020
  QueryPort:
    Description: Fe query port
    Type: String
    Default: 9030
  EditLogPort:
    Description: Fe edit log port
    Type: String
    Default: 9010

  # Be
  SysLogDir:
    Description: Dir to save be log, please to fill in the absolute path
    Type: String
    Default: be default log path
  SysLogLevel:
    Description: Sys Log Level, please select from the drop-down menu
    Type: String
    Default: INFO
    AllowedValues: 
      - INFO
      - WARN
      - ERROR
      - FATAL
  BePort:
    Description: Be port
    Type: String
    Default: 9060
  WebserverPort:
    Description: Webserver port
    Type: String
    Default: 8040
  HeartbeatServicePort:
    Description: Heartbeat service port
    Type: String
    Default: 9050
  BrpcPort:
    Description: Brpc port
    Type: String
    Default: 8060
  VolumeType: 
    Type: String
    Description: EBS volume type (data) to be attached to node in GBs [gp2,gp3,st1], one volume for data storage is mounted automatically by CloudFormation stack.
    Default: gp2
    AllowedValues:
      - gp2
      - gp3
      - st1
      - io1
  VolumeSize: 
    Type: String
    Description: EBS volume size (data) to be attached to node in GBs.
    Default: 50
Conditions:
  4BeNodesCondition: !Or  
    - !Equals [!Ref 'BeNodeCount', '4']
    - !Equals [!Ref 'BeNodeCount', '5']
    - !Equals [!Ref 'BeNodeCount', '6']
  5BeNodesCondition: !Or 
    - !Equals [!Ref 'BeNodeCount', '5'] 
    - !Equals [!Ref 'BeNodeCount', '6']
  6BeNodesCondition: !Equals [!Ref 'BeNodeCount', '6']
Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.cn-northwest-1.amazonaws.com.cn/cf-templates-ieth34xkk4vz-cn-northwest-1/2022053hRF-aws-vpc.template.yaml
      Parameters:
        AvailabilityZones:
          !Join
          - ','
          - !Ref AvailabilityZones
        NumberOfAZs: '2'
        CreateNATGateways: 'true'
        PrivateSubnet1ACIDR: 10.0.128.0/20
        PrivateSubnet2ACIDR: 10.0.144.0/20
        PublicSubnet1CIDR: 10.0.160.0/20
        PublicSubnet2CIDR: 10.0.176.0/20
        VPCCIDR: 10.0.0.0/16
        CreateAdditionalPrivateSubnets: 'false'
        CreatePublicSubnets: 'true'
        CreatePrivateSubnets: 'true'
        CreateVPCFlowLogsToCloudWatch: 'false'
        PrivateSubnet1BCIDR: 10.0.192.0/21
        PrivateSubnet2BCIDR: 10.0.200.0/21
        PrivateSubnet3ACIDR: 10.0.64.0/19
        PrivateSubnet3BCIDR: 10.0.208.0/21
        PrivateSubnet4ACIDR: 10.0.96.0/19
        PrivateSubnet4BCIDR: 10.0.216.0/21
        PrivateSubnetATag1: Network=Private
        PrivateSubnetATag2: ''
        PrivateSubnetATag3: ''
        PrivateSubnetBTag1: Network=Private
        PrivateSubnetBTag2: ''
        PrivateSubnetBTag3: ''
        PublicSubnet3CIDR: 10.0.160.0/20
        PublicSubnet4CIDR: 10.0.176.0/20
        PublicSubnetTag1: Network=Public
        PublicSubnetTag2: ''
        PublicSubnetTag3: ''
        VPCFlowLogsCloudWatchKMSKey: ''
        VPCFlowLogsLogGroupRetention: 14
        VPCFlowLogsMaxAggregationInterval: 600
        VPCFlowLogsTrafficType: REJECT
        VPCTenancy: default
  BastionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.cn-northwest-1.amazonaws.com.cn/cf-templates-ieth34xkk4vz-cn-northwest-1/20220598aE-bastion.template.yaml
      Parameters:
        KeyPairName: !Ref KeyPairName
        ParentStack: StarRocksCluster
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        ImageID: !Ref BastionAmiId
        RemoteAccessCIDR: 0.0.0.0/0
        AdminEmailAddress: starrocks@starrocks.com
  SecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.cn-northwest-1.amazonaws.com.cn/cf-templates-ieth34xkk4vz-cn-northwest-1/2022055W0L-securitygroups.template.yaml
      Parameters:
        AccessCIDR: 0.0.0.0/0
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        VPCCIDR: !GetAtt VPCStack.Outputs.VPCCIDR
        BastionSecurityGroupID: !GetAtt BastionStack.Outputs.BastionSecurityGroupID
  BeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.cn-northwest-1.amazonaws.com.cn/cf-templates-ieth34xkk4vz-cn-northwest-1/20220597Nb-starrocks_be.template.yaml
      Parameters:
        BeNodeCount: !Ref BeNodeCount
        PrivateSubnetID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        StarRocksServerSecurityGroup: !GetAtt SecurityGroupStack.Outputs.StarRocksServerSecurityGroup
        KeyPairName: !Ref KeyPairName
        AmiId: !Ref StaRocksAmiId
        BeNodeInstanceType: !Ref BeNodeInstanceType
        SysLogDir: !Ref SysLogDir
        SysLogLevel: !Ref SysLogLevel
        BePort: !Ref BePort
        WebserverPort: !Ref WebserverPort
        HeartbeatServicePort: !Ref HeartbeatServicePort
        BrpcPort: !Ref BrpcPort
        VolumeType: !Ref VolumeType
        VolumeSize: !Ref VolumeSize
  FeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.cn-northwest-1.amazonaws.com.cn/cf-templates-ieth34xkk4vz-cn-northwest-1/2022059c2n-starrocks_fe.template.yaml
      Parameters:
        PrivateSubnetID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        StarRocksServerSecurityGroup: !GetAtt SecurityGroupStack.Outputs.StarRocksServerSecurityGroup
        KeyPairName: !Ref KeyPairName
        AmiId: !Ref StaRocksAmiId
        FeNodeInstanceType: !Ref FeNodeInstanceType
        LogDir: !Ref LogDir
        SysLogLevel: !Ref SysLogLevel
        MetaDir: !Ref MetaDir
        HttpPort: !Ref HttpPort
        RpcPort: !Ref RpcPort
        QueryPort: !Ref QueryPort
        EditLogPort: !Ref EditLogPort
        BeInstancePrivateIp1: !GetAtt BeStack.Outputs.BeInstancePrivateIp1
        BeInstancePrivateIp2: !GetAtt BeStack.Outputs.BeInstancePrivateIp2
        BeInstancePrivateIp3: !GetAtt BeStack.Outputs.BeInstancePrivateIp3
        BeInstancePrivateIp4: !If
          - 4BeNodesCondition
          - !GetAtt BeStack.Outputs.BeInstancePrivateIp4
          - 0.0.0.0
        BeInstancePrivateIp5: !If
          - 5BeNodesCondition
          - !GetAtt BeStack.Outputs.BeInstancePrivateIp5
          - 0.0.0.0
        BeInstancePrivateIp6: !If
          - 6BeNodesCondition
          - !GetAtt BeStack.Outputs.BeInstancePrivateIp6
          - 0.0.0.0        